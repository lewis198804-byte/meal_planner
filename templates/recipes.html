<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
      .card-img-top {
          width: 100%;
          height: 200px;                    /* Reserves space */
          aspect-ratio: 16/9;              /* Modern fallback */
          object-fit: cover;
          background: #f8f9fa;             /* Loading placeholder */
      }
    </style>
</head>
  <body>
    <section>
         <header >
          <nav class="navbar navbar-expand-lg bg-body-tertiary mb-5">
            <div class="container-fluid">
              <a class="navbar-brand" href="#"><strong>PlatePlanner</strong></a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                  <li class="nav-item">
                    <a class="nav-link "  href="/">Home</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="/recipes">Recipes</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="/add_recipe">Manual Add</a>
                  </li>
                  <li class="nav-item" >
                    <a class="nav-link" href="/ai_recipe_add">AI Add</a>
                  </li>
                  <li class="nav-item" >
                    <a class="nav-link" href="/shopping_list">Shopping List</a>
                  </li>
                  <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                      Dev Tools
                    </a>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="/database_build">Rebuild DB</a></li>
                      <li><a class="dropdown-item" href="#">Another action</a></li>
                      <li><a class="dropdown-item" href="#">Something else here</a></li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
          </nav>
        </header>
    </section>
    <section>
        <div class="container">

          <div class=" text-end row row-col-12 mb-3" > 
                      <div class="col">
                        <a class=" btn btn-small btn-light" data-bs-toggle="modal" data-bs-target="#recipeSearchModal">Search</a> 
                        <div class="dropdown-center d-inline">
                          <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="categoryButton">
                            Category: All
                          </button>
                          <ul class="dropdown-menu">
                            <li><a class="dropdown-item" onclick="categorySelect()">All</a></li>
                            <li><a class="dropdown-item" onclick="categorySelect()">Dinner</a></li>
                            <li><a class="dropdown-item" onclick="categorySelect()">Dessert</a></li>
                            <li><a class="dropdown-item" onclick="categorySelect()">Other</a></li>
                          </ul>
                        </div>
                        
                      </div>
                  </div>
          <div class="row row-cols-1 row-cols-sm-2 row-cols-md-5 justify-content-md-center gy-3" id="recipe_showcase">
          <!--Insert recipes on load via javascript-->
          </div>
          <div class="row row-col-2 pb-4">
            <div class="col text-center pt-4" >
               <a class="btn btn-light d-none"  id="paginationBack">Back</a>
              <!--insert pagination back button-->
            </div>
            <div class="col text-center pt-4" >
              <a class="btn btn-light d-none"  id="paginationNext">Next</a>
              <!--insert pagination next button-->
            </div>
          </div>
        </div>


        <!-- Modal -->
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Delete Recipe</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this recipe? 
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="modal_delete_button">Save changes</button>
            </div>
            </div>
        </div>
        </div>

        <!--Recipe search Modal-->
        <div class="modal fade " id="recipeSearchModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel">Recipe Search</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="p-3">
                <div class="form-floating mb-3">
                  <input type="email" class="form-control" id="searchInput" placeholder="name@example.com">
                  <label for="searchInput">Recipe Search</label>
                </div>
              </div>
              <div class="modal-body">
                <ul class="list-group" id="search_results_list">
                  <!--Insert search results here via Javascript-->
                </ul>
              </div>
              <div class="modal-footer">
                <button type="button" onclick="clearSearchModal()" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              </div>
            </div>
          </div>
        </div>

        <!--Recipe info Modal-->
        <div class="modal fade " id="recipeDetailsModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">          
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header" id="recipeInfoHeader">
                
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="container">
                  <div class="row row-col-2">
                    <div class="col" id="recipeInfoImage">
                      <!--Insert recipe photo here with javascript-->
                    </div>
                    <div class="col" id="recipeInfoDesc">
                      <p>Recipe details</p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer" id="recipeInfoFooter">
                
              </div>
            </div>
          </div>
        </div>
    </section>
   
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
  
    <script>
      const recipe_showcase = document.getElementById("recipe_showcase")
      const modal_delete_button = document.getElementById("modal_delete_button")

      const searchInput = document.getElementById("searchInput");
      const search_results_list = document.getElementById("search_results_list");

      const recipeInfoHeader = document.getElementById("recipeInfoHeader");
      const recipeInfoImage = document.getElementById("recipeInfoImage");
      const recipeInfoDesc = document.getElementById("recipeInfoDesc");
      const recipeInfoFooter = document.getElementById("recipeInfoFooter")
      const viewRecipeLink = document.getElementById("viewRecipeLink");

      const categoryButton = document.getElementById("categoryButton")

      const paginationBack = document.getElementById("paginationBack");
      const paginationNext = document.getElementById("paginationNext");

      let itemsPerPageLimit = 4;

      loadRecipes("all")


      async function loadRecipes(category,lastResult = "",direction = "start"){
            if (category != ""){
              
              let charArray = category.split('');
              charArray[0] = charArray[0].toUpperCase(); 
              finalCat = charArray.join('');
              
              categoryButton.innerText = "Category: "+finalCat;
              recipe_showcase.dataset.category = category

            }
            if (lastResult != ""){
              paginationId = "&paginationId="+lastResult
              console.log(paginationId)
            }
            else {
              paginationId = ""
            }
            if (direction != ""){
              directionVar = "&direction="+direction;
            }
            else {
              directionVar = "";
            }
            try {
                const response = await fetch('/get_recipes?category='+category+""+paginationId+""+directionVar,{
                    method: 'POST'
                });
                const recipes = await response.json();
                
                const recipesRetrievedCount = recipes.length

                contents = ""
                if (recipes.length == 0){
                    recipe_showcase.innerHTML = "No Recipes found";
                    paginationBack.classList.add("d-none");
                    paginationNext.classList.add("d-none");
                      
                }
                else{
                  if (recipes.length <= itemsPerPageLimit){
                    numberToShow = recipes.length;
                  }
                  else{
                    numberToShow = itemsPerPageLimit
                  }
                  
                  if(recipes.length > numberToShow){
                    paginationLinks = true
                  }
                  else{
                    paginationLinks = false;
                  }

                  //remove the last item in the response (if over the number to be
                  // displayed per page) as this was only retrieved to test for pagination
                  //need
                  if (recipes.length > numberToShow){
                    recipes.pop();  
                  }
                  //if it is the previous button that has been pressed to trigger this function
                  //reverse the order of resutls to display accurately 
                  if (direction == "back"){
                    recipes.reverse();
                  }
                  //set variables for the first rendered recipe and the last rendered recipe
                  const firstId = recipes[0][0];
                  const lastId = recipes[recipes.length - 1][0]; 

                  for (let i = 0;i < numberToShow; i++){
                      contents += '\
                      <div class="col">\
                        <div class="card animate_animated animate__bounceIn" style="height:100%;">\
                          <a href="/view_recipe?q='+recipes[i][0]+'">\
                          <img src="/static/recipe_images/'+recipes[i][5]+'" loading="lazy" class="card-img-top " style="height: 200px; " alt="...">\
                          </a>\
                          <div class="card-body">\
                            <h5>'+recipes[i][1]+'</small></h5>\
                            <p class="small">'+recipes[i][2] + '. Pg:'+recipes[i][3]+'</p>\
                            <p><a href="/view_recipe?q='+recipes[i][0]+'" class="btn btn-primary">View Recipe</a></p>\
                            <p><a href="" class="btn btn-light btn-sm" style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;" data-bs-toggle="modal" data-bs-target="#deleteModal" onclick="openDeleteModal('+recipes[i][0]+')">Delete Recipe</a> <a class="btn btn-light btn-sm" style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;"  href="/edit_recipe?q='+recipes[i][0]+'" >Edit Recipe</a></p>\
                          </div>\
                        </div>\
                      </div>\
                      '
                  }
                  recipe_showcase.innerHTML = contents

                  //sort out pagination links, adjsuting visiblity and variables based on count of recipes
                  //retrieved and whether the next or back buttons were pressed. 

                  //if the next button is pressed or the page has just loaded fresh
                  //if the number of retrieved recipes is higher than the amount wanted to be displayed
                  //show next pagination button and adjust its onclick with variables to load next recipes in order
                  if (direction == "next" || direction == "start"){
                    if(recipesRetrievedCount > numberToShow){
                      paginationNext.classList.remove("d-none")
                      paginationNext.setAttribute("onclick","loadRecipes(\""+recipe_showcase.dataset.category+"\","+lastId+",\"next\")");
                      if (direction != "start"){
                        paginationBack.setAttribute("onclick","loadRecipes(\""+recipe_showcase.dataset.category+"\","+firstId+",\"back\")");
                        paginationBack.classList.remove("d-none")
                      }
                      else if (direction == "start" && !paginationBack.classList.contains("d-none"))
                        paginationBack.classList.add("d-none");
                    
                    }
                    //if the number of recipes returned is less than or equal to the amount wanted to be shown
                    else{
                      if (direction == "start" ){
                        paginationBack.classList.add("d-none");
                        paginationNext.classList.add("d-none");
                      }
                      else{
                        paginationNext.classList.add("d-none")
                        paginationBack.setAttribute("onclick","loadRecipes(\""+recipe_showcase.dataset.category+"\","+firstId+",\"back\")");
                        paginationBack.classList.remove("d-none")
                      }
                      
                    }
                  }

                  if (direction == "back"){
                    if(recipesRetrievedCount > numberToShow){
                      paginationBack.classList.remove("d-none")
                      paginationBack.setAttribute("onclick","loadRecipes(\""+recipe_showcase.dataset.category+"\","+firstId+",\"back\")");
                  
                      paginationNext.classList.remove("d-none")
                      paginationNext.setAttribute("onclick","loadRecipes(\""+recipe_showcase.dataset.category+"\","+lastId+",\"next\")");
  
                    }
                    else{
                      paginationBack.classList.add("d-none")
                      paginationNext.setAttribute("onclick","loadRecipes(\""+recipe_showcase.dataset.category+"\","+lastId+",\"next\")");
                      paginationNext.classList.remove("d-none")
                    }

                  }
                }
            }
            catch(error){
                console.log(error);
            }
        }

        function openDeleteModal(recipe_id){
            modal_delete_button.setAttribute("onclick","deleteRecipe("+recipe_id+");")
        }


        async function deleteRecipe(recipe_id){
            try {
                const response = await fetch('/del_recipe?q='+recipe_id);
                const del_response = await response

                if (del_response.ok){
                    //console.log(response)
                    loadRecipes("all")
                }
            }
            catch(error){
                console.log(error)
            }
        }


            // Waits for typing to pause before searching
      function debounce(fn, delayMs) {
        let timeoutId = null;
        
        return async function(...args) {
          // Cancel previous timer
          if (timeoutId) {
            clearTimeout(timeoutId);
          }
          
          // Wait for pause, then call fn
          timeoutId = setTimeout(async () => {
            await fn(...args);
          }, delayMs);
        };
      }

      // Usage with async/await
      const debouncedSearch = debounce(async (searchTerm) => {
        if (searchTerm == ""){
          showResults([])
        }
        else{
        const response = await fetch('/search_recipes?q='+encodeURIComponent(searchTerm)+'');
        const results = await response.json();
        showResults(results);
        }
      }, 500);

      searchInput.addEventListener('input', (e) => {
        debouncedSearch(e.target.value);
      });


      function clearSearchModal(){
        searchInput.value = ""
        search_results_list.innerHTML = ""
        recipeInfoHeader.innerHTML = ""
        recipeInfoImage.innerHTML = ""
      }

      function showResults(data){
        
        //console.log(data)
        list_content = "";

        if (data.length > 0){
          data.forEach(element => {

              list_content += '<li class="list-group-item d-flex justify-content-between align-items-start list-group-item-action">\
              <div>'+element[1]+' </div>\
              <div class="btn-group" role="group" aria-label="Basic example">\
                <a class="btn btn-primary" href="view_recipe?q='+element[0]+'">View</a>\
                <button class="btn btn-info" data-bs-target="#recipeDetailsModal" data-bs-toggle="modal"  onclick="getRecipeOverview(\''+element[0]+'\')">Info</button>\
              </div></li>'
            });
        }
        else {
          list_content = '<li class="list-group-item">No recipes found</li>';
        }

        search_results_list.innerHTML = list_content;
        
      }

      async function getRecipeOverview(recipeId){

        const response = await fetch("/get_recipe_overview/"+recipeId,{method : 'GET'});
        const result = await response.json()
        recipeInfoHeader.innerHTML = '<h1 class="modal-title fs-5" id="exampleModalToggleLabel" id="recipeInfoHeader">'+result['name']+'</h1>';
        recipeInfoImage.innerHTML =  '<img src="/static/recipe_images/'+result['photo_path']+'" class="card-img-top img-thumbnail img-fluid" style="height: 150px; object-fit: cover;" alt="...">'
        recipeInfoDesc.innerHTML = result['desc']
        recipeInfoFooter.innerHTML = '<a href="/view_recipe?q='+recipeId+'" id="viewRecipeLink" class="btn btn-primary">View</a>\
                <button class="btn btn-primary" data-bs-target="#recipeSearchModal" data-bs-toggle="modal">Back</button>' 
      }

      function categorySelect(){
        const categorySelected = event.target.innerText.toLowerCase()
        loadRecipes(categorySelected)
      }




    </script>




</body>
</html>