<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>PlatePlanner</title>

    <!--Animation CSS effects-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <!--Bootstrap styles-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <!--Custom CSS changes-->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom_styling.css') }}" />
    <!--JS that gets laoded once the site has been rendered.-->
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
  </head>

  <body>
    <section>
        <header >
          <nav class="navbar navbar-expand-lg bg-body-tertiary mb-2">
            <div class="container-fluid">
              <a class="navbar-brand" href="/"><strong>PlatePlanner</strong></a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                  <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="/">Home</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="/recipes">Recipes</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="/add_recipe">Manual Add</a>
                  </li>
                  <li class="nav-item" >
                    <a class="nav-link" href="/ai_recipe_add">AI Add</a>
                  </li>
                  <li class="nav-item" >
                    <a class="nav-link" href="/shopping_list">Shopping List</a>
                  </li>
                  <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                      Dev Tools
                    </a>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="/database_build">Rebuild DB</a></li>
                      <li><a class="dropdown-item" href="#">Another action</a></li>
                      <li><a class="dropdown-item" href="#">Something else here</a></li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
          </nav>
        </header>
    </section>
    <section>
        <div class="container" >
          
                  <div class=" text-end row row-col-12" > 
                      <div class="col">
                        <a class=" btn btn-small btn-light" data-bs-toggle="modal" data-bs-target="#changeRecipeModal" onclick="setSearchModal(null, 'true')">Search</a> 
                        <a class=" btn btn-small btn-light" data-bs-toggle="offcanvas" data-bs-target="#newMenuOffcanvas" aria-controls="newMenuOffcanvas"> New plan </a> 
                      </div>
                  </div>
          <div class="row row-cols-2 row-cols-md-3 justify-content-center" id="meal_plan_showcase">

          </div>
        </div>

<!--Modal window layouts-->
        <!--Recipe change Modal-->
        <div class="modal fade " id="changeRecipeModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel">Recipe Search</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="p-3">
                <div class="form-floating mb-3">
                  <input type="email" class="form-control" id="searchInput" placeholder="name@example.com">
                  <label for="searchInput">Recipe Search</label>
                </div>
              </div>
              <div class="modal-body">
                <ul class="list-group" id="search_results_list">
                  <!--Insert search results here via Javascript-->
                </ul>
              </div>
              <div class="modal-footer">
                <button type="button" onclick="clearSearchModal()" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              </div>
            </div>
          </div>
        </div>

        <!--Recipe info Modal-->
        <div class="modal fade " id="swapRecipeDetailsModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">          
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header" id="recipeInfoHeader">
                
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="container">
                  <div class="row row-col-2">
                    <div class="col" id="recipeInfoImage">
                      <!--Insert recipe photo here with javascript-->
                    </div>
                    <div class="col" id="recipeInfoDesc">
                      <p>Recipe details</p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer" id="recipeInfoFooter">
                
              </div>
            </div>
          </div>
        </div>

<!--Offcanvas layouts-->
        <!--New Menu Plan Offcanvas-->
        <div class="offcanvas offcanvas-start" tabindex="-1" id="newMenuOffcanvas" aria-labelledby="newMenuOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="newMenuOffcanvasLabel">New Meal Plan</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <div>
              New week, new plan! Or you just don't like the current one? Put together a new meal plan here!
            </div>
            <div class="mt-3 text-center">
                <div class="p-2">
                  <button onclick="checkGeneratePlanType('param')" class="btn btn-primary" href="#">Enter paramaters</button>
                </div>
                <div class="p-2">
                  <button onclick="checkGeneratePlanType('auto')" class="btn btn-primary" href="#">Generate Auto Plan</button>
                </div>
            </div>
            
            <div class="mt-3">
              <div id="paramsContainer" class="d-none">
                <form id="paramsFormSubmit">
                  <div class="mb-3" id="formContainer">
                    
                    
                  </div>
                  <div class="mt-2 text-center p-3">
                    <button type="submit" class="btn btn-primary">Submit</button>
                  </div>
                </form>
              </div>
                <div class="accordion" id="generatedPlanList">
                  <!-- insert auto generated meal plan here via javascript-->
                </div>
                
              
              <div class="mt-2 text-center p-3">
                <button id="newPlanSubmit" class="btn btn-primary d-none" data-bs-dismiss="offcanvas" onclick="saveNewPlan()">Looks Good!</button>
              </div>
            </div>
          </div>
        </div>
    </section>
   
    <script>

      
      const recipe_showcase = document.getElementById("recipe_showcase");
      const meal_plan_showcase = document.getElementById("meal_plan_showcase");
      const searchInput = document.getElementById("searchInput");
      const search_results_list = document.getElementById("search_results_list");
      const submitChangeButton = document.getElementById("submitChangeButton");
      const changeRecipeModal = document.getElementById("changeRecipeModal");

      const recipeInfoHeader = document.getElementById("recipeInfoHeader");
      const recipeInfoImage = document.getElementById("recipeInfoImage");
      const recipeInfoSwapButton = document.getElementById("recipeInfoSwapButton");
      const recipeInfoDesc = document.getElementById("recipeInfoDesc");
      const recipeInfoFooter = document.getElementById("recipeInfoFooter")
      const viewRecipeLink = document.getElementById("viewRecipeLink");

      const generatedPlanList = document.getElementById("generatedPlanList");
      const newPlanSubmit = document.getElementById("newPlanSubmit");
      const newMenuOffcanvas = document.getElementById("newMenuOffcanvas");

      const paramsContainer = document.getElementById("paramsContainer");
      const formContainer = document.getElementById("formContainer");
      const paramSelects = document.getElementsByClassName("param-selectors");
      const paramsFormSubmit = document.getElementById('paramsFormSubmit');

      paramsFormSubmit.addEventListener('submit', function(event) {
          event.preventDefault();
          processParams();
      });

      
      const weekday = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
      const paramsOptions = ["Any", "Batch Cook - A", "Batch Cook - B", "Batch Cook - C","Meat Free", "Quick meal", "Fakeaway", "Vegetarian","Meaty"]

      newMenuOffcanvas.addEventListener("hidden.bs.offcanvas", clearNewMenuOffcanvas)

      loadMenu()
      setDropdown()

      async function loadMenu(){
        try{
          const response = await fetch('/get_menu', {
            method : 'POST'
          });

          const fullResponse = await response.json();
          const menu = fullResponse.menu;  // Extract the array
          meal_plan_contents = ""
          console.log(menu)
          console.log(menu.length)
          if (menu.length == 0){
            meal_plan_contents =  ' <div class="col-lg-3 col-md-6 col-12" for each day>\
                              <div class="card h-100">  <!-- h-100 fills height -->\
                                <div class="card-header bg-primary text-white text-center">\
                                  <h5>Monday</h5>  <!-- Short day name -->\
                                </div>\
                                <div class="card-body d-flex flex-column">\
                                  <h6 class="card-title">Recipe Name</h6>\
                                  <p class="card-text text-muted small mb-2">Difficulty: Medium</p>\
                                  <p class="card-text flex-grow-1">Short instructions preview...</p>\
                                  <div class="card-footer bg-light">\
                                    <small>Source: Pinch of Nom</small>\
                                  </div>\
                                </div>\
                              </div>\
                            </div>\
                          '
          }
          else{
            const d = new Date();
            let today = weekday[d.getDay()];
            today = capitalizeFirstLetter(today);
            
            menu.forEach((dayObj, index) => {
              const day = Object.keys(dayObj)[0];
              const recipe = dayObj[day];
              let recipe_day_name = day.split("_")[0];
              recipe_day_name = capitalizeFirstLetter(recipe_day_name);

              
              if (recipe_day_name == today){
                highlight_today = "border-warning border-4"
                today_badge = "<span class='badge text-bg-warning position-absolute' style='top:15px;left:15px;'>Today!</span>"
              }
              else{
                highlight_today = ""
                today_badge = ""
              }
                meal_plan_contents += '\
                <div class="col ">\
                  <div class="card '+highlight_today+' mt-4 position-relative animate_animated animate__bounceIn">\
                      <a href="/view_recipe?q='+recipe['id']+'" >\
                    <img onload="setLoaded()" src="/static/recipe_images/'+recipe['photo_path']+'" class="recipe-img card-img-top img-thumbnail" style="height: 150px; object-fit: cover;" alt="...">\
                    </a>\
                    <div class="" style="position:absolute;top:20px;right:20px;">\
                        <a href="/view_recipe?q='+recipe['id']+'" onclick="setSearchModal(\''+day+'\',\'false\')" class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#changeRecipeModal">Change</a><br>\
                      </div>\
                    <div class="card-body">\
                    '+today_badge+'\
                      <h3 class="text-center">'+recipe_day_name+'</h3>\
                      <p class="text-center">'+recipe['name']+'</p>\
                      <div class="flex">\
                      <a href="/view_recipe?q='+recipe['id']+'" class="btn btn-primary">View Recipe</a><br>\
                      </div>\
                    </div>\
                  </div>\
                </div>\
                '
            });
          }
          meal_plan_showcase.innerHTML = meal_plan_contents
        }
        catch (error){
          console.log("Error occured: "+error)
        }
      }

     function setLoaded(){
      img = event.target;
      img.setAttribute('loaded', '');

     }

      function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      }

      // Waits for typing to pause before searching
      function debounce(fn, delayMs) {
        let timeoutId = null;
        
        return async function(...args) {
          // Cancel previous timer
          if (timeoutId) {
            clearTimeout(timeoutId);
          }
          
          // Wait for pause, then call fn
          timeoutId = setTimeout(async () => {
            await fn(...args);
          }, delayMs);
        };
      }

      // Usage with async/await
      const debouncedSearch = debounce(async (searchTerm) => {
        if (searchTerm == ""){
          showResults([])
        }
        else{
        const response = await fetch('/search_recipes?q='+encodeURIComponent(searchTerm)+'');
        const results = await response.json();
        showResults(results);
        }
      }, 500);

      searchInput.addEventListener('input', (e) => {
        debouncedSearch(e.target.value);
      });


       function setSearchModal(dayId = null, trigger = ""){
        console.log(dayId)
        if (dayId != null){
          changeRecipeModal.setAttribute("data-recipe-day", ""+dayId+"")
        }
        if (trigger == "false"){
          changeRecipeModal.dataset.search_recipes = "true"
        }
        else if (trigger == "true" ){
          changeRecipeModal.dataset.search_recipes = "false"
        }
      }
     
      async function saveChange(recipeDayId, newRecipeId){
        event.target.parentElement.classList.add("b-5");
        const changeData = new FormData();
        changeData.append("dayToChange", recipeDayId);
        changeData.append("newRecipe",newRecipeId)
        const response = await fetch("/save_recipe_day_change/" , {method : 'POST', body : changeData});
        const result = await response.json()
        clearSearchModal()
        loadMenu()
      }

      function clearSearchModal(){
        searchInput.value = ""
        search_results_list.innerHTML = ""
        recipeInfoHeader.innerHTML = ""
        recipeInfoImage.innerHTML = ""
      }

      function showResults(data){
        const recipeDay = changeRecipeModal.getAttribute("data-recipe-day")
        console.log(data)
        list_content = "";

        if (data.length > 0){
          data.forEach(element => {
            if (changeRecipeModal.dataset.search_recipes == "true"){
              swapButton = '<button onclick="saveChange(\''+recipeDay+'\',\''+element[0]+'\')" data-bs-dismiss="modal" class="btn btn-primary btn-sm">Swap</button> </li>'
            }
            else{
              swapButton = ""
            }
              list_content += '<li class="list-group-item d-flex justify-content-between align-items-start list-group-item-action">\
              <div>'+element[1]+' </div>\
              <div class="btn-group" role="group" aria-label="Basic example">\
                <a class="btn btn-primary" href="view_recipe?q='+element[0]+'">View</a>\
                <button class="btn btn-info" data-bs-target="#swapRecipeDetailsModal" data-bs-toggle="modal" href="#offcanvasExample" onclick="getRecipeOverview(\''+element[0]+'\')">Info</button>\
              '+swapButton+'\
              </div>'
            });
        }
        else {
          list_content = '<li class="list-group-item">No recipes found</li>';
        }

        search_results_list.innerHTML = list_content;
        
      }

      async function getRecipeOverview(recipeId){
         const recipeDay = changeRecipeModal.getAttribute("data-recipe-day")

        if (changeRecipeModal.dataset.search_recipes == "true"){
             recipeInfoFooter.innerHTML =  '<a href="/view_recipe?q='+recipeId+'" id="viewRecipeLink" class="btn btn-primary">View</a>\
                <button class="btn btn-primary" data-bs-target="#changeRecipeModal" data-bs-toggle="modal">Back</button>\
                <button class="btn btn-primary" id="recipeInfoSwapButton" onclick="saveChange(\''+recipeDay+'\','+recipeId+')" data-bs-dismiss="modal">Swap In!</button>'
 
            }
            else{
              recipeInfoFooter.innerHTML = '<a href="/view_recipe?q='+recipeId+'" id="viewRecipeLink" class="btn btn-primary">View</a>\
                <button class="btn btn-primary" data-bs-target="#changeRecipeModal" data-bs-toggle="modal">Back</button>' 
            }
        const response = await fetch("/get_recipe_overview/"+recipeId,{method : 'GET'});
        const result = await response.json()
        recipeInfoHeader.innerHTML = '<h1 class="modal-title fs-5" id="exampleModalToggleLabel" id="recipeInfoHeader">'+result['name']+'</h1>';
        recipeInfoImage.innerHTML =  '<img src="/static/recipe_images/'+result['photo_path']+'" class="card-img-top img-thumbnail img-fluid" style="height: 150px; object-fit: cover;" alt="...">'
        recipeInfoDesc.innerHTML = result['desc']
        
      }

      async function checkGeneratePlanType(planType){
        if (planType == "auto"){
          if (!paramsContainer.classList.contains("d-none")){
            paramsContainer.classList.add("d-none");
          }
          const planData = new FormData()
          planData.append("planType", planType);
          const response = await fetch('/gen_new_meal_plan' ,{method:'POST', body : planData});
          const potentialPlan = await response.json();
          console.log(potentialPlan);
          listContent = "";
          dayOfTheWeek = 1;
          const newPlan = new Object()
          potentialPlan.forEach(element => {
            

            listContent +='<div class="accordion-item">\
                    <h2 class="accordion-header">\
                      <button class="accordion-button collapsed" aria-expanded="false" type="button" data-bs-toggle="collapse" data-bs-target="#'+weekday[dayOfTheWeek]+'Item" aria-expanded="true" aria-controls="collapseOne">  \
                        '+element['name']+'  <span class="badge text-bg-warning ms-1"> '+weekday[dayOfTheWeek]+'</span>\
                      </button>\
                    </h2>\
                    <div id="'+weekday[dayOfTheWeek]+'Item" class="accordion-collapse collapse " data-bs-parent="#generatedPlanList">\
                      <div class="accordion-body">\
                        <div class="container">\
                          <div class="row row-col-2">\
                            <div class="col">\
                              <img src="/static/recipe_images/'+element["photo_path"]+'" class="card-img-top img-thumbnail img-fluid" style="height: 150px; object-fit: cover;" alt="...">\
                            </div>\
                            <div class="col">\
                              <p> '+element["desc"]+'</p>\
                              <p class="small">'+element["tags"]+'</p>\
                            </div>\
                          </div>\
                          </div>\
                      </div>\
                    </div>\
                  </div>'
            newPlan[weekday[dayOfTheWeek].toLowerCase()+"_recipe_id"] = element['id'];
            dayOfTheWeek += 1;
            if (dayOfTheWeek > 6){dayOfTheWeek = 0;}
          });
          generatedPlanList.innerHTML = listContent;
          if (newPlanSubmit.classList.contains("d-none")){newPlanSubmit.classList.remove("d-none");}
          newPlanSubmit.dataset.plan = JSON.stringify(newPlan);
          
          //console.log(newPlan);
          //generate new meal plan automatically, with no user input
        }
        else if (planType == "param"){
          if (newPlanSubmit.dataset.plan != ""){
            delete newPlanSubmit.dataset.plan
          }

          if (paramsContainer.classList.contains("d-none")){
            paramsContainer.classList.remove("d-none");
            generatedPlanList.innerHTML = "";
            if (!newPlanSubmit.classList.contains("d-none")){
              newPlanSubmit.classList.add("d-none")
            }
          }
          //show form for parameter entry, then submit and generate meal plan based on params. 
        }
      }

      async function saveNewPlan(){
        const passedData = JSON.parse(newPlanSubmit.dataset.plan);
        const newPlanData = new FormData()
        for (const day in passedData) {
          newPlanData.append(day, passedData[day]);
        }
        const response = await fetch('/save_new_plan' ,{ method:'POST', body : newPlanData});
        const result = await response.json();
        if (result.success == "ok"){
          loadMenu()
        }
      }
      function clearNewMenuOffcanvas(){
        delete newPlanSubmit.dataset.plan
        if (!newPlanSubmit.classList.contains("d-none")){newPlanSubmit.classList.add("d-none");}
        generatedPlanList.innerHTML = "";
        if (!paramsContainer.classList.contains("d-none")){
          paramsContainer.classList.add("d-none");
          for (let i = 0; i < paramSelects.length; i++)   {         
            paramSelects[i].value = "Any";
          };
        }
      }

      function setDropdown(){
        let selectContent = ""
        paramsOptions.forEach(param => {
          selectContent += "<option value='"+param+"'>"+param+"</option>"
        });
        formContainerContent = "";
        paramsArray = [];
        weekday.forEach(day => {

          paramsArray.push( '<label for="'+day+'Dropdown" class="form-label">'+day+' Parameter</label>\
                                  <select id="'+day+'Dropdown" class="form-select param-selectors" aria-label="Default select example">\
                                    '+selectContent+'\
                                  </select>')
            
        });
        
        //set index of sunday (as sunday is the first day in the weekdays array, but don't want it first in params list)
        sundayIndex = paramsArray.length +1
        //move sunday input to the end of the parameter select array
        paramsArray.splice(sundayIndex, 1, paramsArray.splice(0, 1));
        //join the array together with whitespace and set it to variable
        formContainerContent =  paramsArray.join('');
        
        formContainer.innerHTML = formContainerContent;
      }

      async function processParams(){
        day_columns = ["monday","tuesday","wednesday","thursday","friday","saturday","sunday"]

        paramFormData = new FormData()
        for (let i = 0; i < paramSelects.length; i++){
          paramFormData.append(day_columns[i] , paramSelects[i].value);
        }
        const request = await fetch("/process_params", {method:'POST', body : paramFormData});
        const response = await request.json();

        
        listContent = "";
        const newPlan = new Object()
        Object.entries(response['results']).forEach(([key, value]) => {
          if (value['mealType'] == "batch"){
            mealBadge = "<span class='badge text-bg-success ms-1'> Batch meal</span>"
          }
          else{
            mealBadge = "";
          }

          listContent +='<div class="accordion-item">\
                    <h2 class="accordion-header">\
                      <button class="accordion-button collapsed" aria-expanded="false" type="button" data-bs-toggle="collapse" data-bs-target="#'+key+'Item" aria-expanded="true" aria-controls="collapseOne">  \
                        '+value['name']+'  <span class="badge badge-sm text-bg-warning ms-1"> '+capitalizeFirstLetter(key)+'</span>'+mealBadge+'\
                      </button>\
                    </h2>\
                    <div id="'+key+'Item" class="accordion-collapse collapse " data-bs-parent="#generatedPlanList">\
                      <div class="accordion-body">\
                        <div class="container">\
                          <div class="row row-col-2">\
                            <div class="col">\
                              <img src="/static/recipe_images/'+value["photo_path"]+'" class="card-img-top img-thumbnail img-fluid" style="height: 150px; object-fit: cover;" alt="...">\
                            </div>\
                            <div class="col">\
                              <p> '+value["desc"]+'</p>\
                              <p class="small">'+value["tags"]+'</p>\
                            </div>\
                          </div>\
                          </div>\
                      </div>\
                    </div>\
                  </div>'
          newPlan[key+"_recipe_id"] = value['id'];

        });
        generatedPlanList.innerHTML = listContent
        if (newPlanSubmit.classList.contains("d-none")){newPlanSubmit.classList.remove("d-none");}
        newPlanSubmit.dataset.plan = JSON.stringify(newPlan);
        newPlanSubmit.setAttribute("onclick", "saveNewPlan()");
      }
    </script>
  </body>

</html>