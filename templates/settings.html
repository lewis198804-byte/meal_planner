<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>PlatePlanner</title>

    <!--Animation CSS effects-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <!--Bootstrap styles-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <!--Custom CSS changes-->
    <!--<link rel="stylesheet" href="{{ url_for('static', filename='css/custom_styling.css') }}" />-->
    <!--JS that gets laoded once the site has been rendered.-->
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
  
    <style>

      #backupSettings{
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.9s ease;
      }
      #backupSettings.backupVisible {
       max-height: 200px; /* adjust to fit your content */
      }


    </style>





  
  
  
  </head>

  <body>
    <section>
        <header >
          <nav class="navbar navbar-expand-lg bg-body-tertiary mb-2">
            <div class="container-fluid">
              <a class="navbar-brand" href="/"><strong>PlatePlanner</strong></a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                  <li class="nav-item">
                    <a class="nav-link" aria-current="page" href="/">Home</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="/recipes">Recipes</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="/add_recipe">Manual Add</a>
                  </li>
                  <li class="nav-item" >
                    <a class="nav-link" href="/ai_recipe_add">AI Add</a>
                  </li>
                  <li class="nav-item" >
                    <a class="nav-link" href="/shopping_list">Shopping List</a>
                  </li>
                  <li class="nav-item" >
                    <a class="nav-link active" href="/settings">Settings</a>
                  </li>
                </ul>
              </div>
            </div>
          </nav>
        </header>
            <div class=" text-center mt-5 mx-auto" style="width:40em">
                <h1>Settings</h1>
            </div>
        </header>
    </section>
    <section>
        <div class="container ">
          <div class="row">
            <div class="alert p-3 text-center" id="saveOutcome">
              <!--insert save outcome here via JS-->
            </div>
          </div>
          <div class="row   mt-5">
            <div class="col col-12 col-md-6 text-start">
              <div class=" p-3">
                Check your API key is detected and working correctly! 
              </div>
            </div>
            <div class="col col-12 col-md-6">
              <div class="p-1 text-center">
                <form >
                  <div class="form-floating">
                    
                    <input type="text" id="apiTextInput" disabled class="form-control bg-success-subtle" placeholder="Open AI Api Key" data-bs-toggle="tooltip" data-bs-placement="top"
                      data-bs-custom-class="custom-tooltip"
                      data-bs-title="Make changes to your API key by editing your .env file.">
                    <label for="api_key" class="form-label">Open AI Api Key</label>
                      <div class="form-text" id="apiConfigText">
                        <!--input api status here-->
                      </div>
                      <div>
                        <span id="testResult" class="small p-1"></span> <br><button class="mt-1 btn btn-primary" disabled id="testKeyButton" onclick="testApi()">Test key</button>
                      </div>

                  </div>

                
              </div>
            </div>
            <div class="col col-12 col-md-6 text-start">
              <div class=" p-3">
                Create backups of your recipe database?
              </div>
            </div>
            <div class="col col-12 col-md-6">
              <div class="p-3 text-start" >
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" role="switch" id="backupToggleSwitch" onchange="toggleBackupSettingsVis()">
                </div>
                <div id="backupSettings" class="mt-4">
                  <div id="nextBackupText"></div>
                  <select class="form-select" id="backupFrequency">
                    <option value="1">Daily</option>
                    <option value="7">Every 7 days</option>
                    <option value="14">Fortnightly</option>
                  </select>
                  
                  <label for="formFile" class="small">Backup Location</label>
                  <input class="form-control" type="text" id="backupDir" placeholder="e.g. /home/documents/backups/">
                  <div id="schedulerStatusText"></div>
                </div>
                <div class="small alert p-1 mt-2" id="backupAlert">
                    <!--insert backup info here via JS-->
                  </div>
                </div>
            </div>
            <div class="col col-12 text-center">
              <button class="btn btn-primary" id="saveButton" onclick="saveSettings()">Save</button>
            </div>
          </form>
    </section>
   
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script>

      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

      const apiKeyField = document.getElementById("apiTextInput");
      const saveButton = document.getElementById("saveButton");
      const saveOutcomeAlert = document.getElementById("saveOutcome");
      const apiStatusText = document.getElementById("apiConfigText")
      const testButton = document.getElementById("testKeyButton");
      const testResult = document.getElementById("testResult");

      const backupSettings = document.getElementById("backupSettings");
      const backupToggle = document.getElementById("backupToggleSwitch");
      const backupInput = document.getElementById("backupDir");
      const backupFreq = document.getElementById("backupFrequency")
      const backupAlert = document.getElementById("backupAlert")
      const backupTimeInput = document.getElementById("backupTime")

      const schedulerStatusText = document.getElementById("schedulerStatusText")
      const nextBackupText = document.getElementById("nextBackupText")
      
      //backupSettings.hidden = true
      saveOutcomeAlert.hidden = true;
      populateSettings()


      
      async function populateSettings(){
        const response = await fetch("/get_settings");
        const res = await response.json();
        console.log(res)
        if (res.ok == "true"){
          if (res['apiKey'] != ""){
            apiStatusText.innerText = "Success! API key configured in .env file";
            apiKeyField.value = res['apiKey'];
            testButton.disabled = false;
          if (res['backupLoc'] != ""){
            //enable backup button, else disable it
          }
          }
          else{
            apiStatusText.innerText = "No API key detected in .env file. Follow documentation to set your API key.";
            apiKeyField.value = "No API key detected";
          }
          //backups are turned on
          if (res.settings[1] == "on"){
            //show status of the backup scheduler as this should be running. 
            if (res.backup_details.scheduler_status == 1){
              schedulerStatusText.innerHTML = "<span style='color:green;'>The backup scheduler is running</span>";
              nextBackupText.innerHTML = " Next backup is due on "+res.backup_details.next_backup;
            }
            else if(res.backup_details.scheduler_status == 0){
              schedulerStatusText.innerHTML = "<span style='color:red;'>Backup Scheduler is not currently running. Likely an error.</span>";
            }
            backupToggle.checked = true;
            backupSettings.classList.add("backupVisible")
            if (res['settings'][2] != null){
              backupInput.value = res.settings[2]
              backupFreq.value = res.settings[3]
            }
          }
        }
        else{
          console.log("there was an error loading settings")
        }
      }


      async function testApi(){
        event.preventDefault()
        const response = await fetch("/test_api");
        const res = await response.json();
        
        const testData = JSON.parse(res);
        console.log(testData)
        if(testData.ok == "true"){
          testResult.innerText = "Your API key is configured and working"
          testResult.classList.add("bg-success-subtle")
          if (testResult.classList.contains("bg-warning-subtle")){
            testResult.classList.remove("bg-warning-subtle")
          }
        }
        else if (testData.ok == "false"){
          testResult.innerText = "Your API key didnt work. Error: "+ res.errorText
          testResult.classList.add("bg-warning-subtle")
          if (testResult.classList.contains("bg-success-subtle")){
            testResult.classList.remove("bg-success-subtle")
          }
        }
      }

      function toggleBackupSettingsVis(){
        if (event.srcElement.checked){
          backupSettings.classList.add("backupVisible");
        }
        else if (!event.srcElement.checked){
          backupSettings.classList.remove("backupVisible");
        }
      }

      async function backupManual(){
        event.preventDefault()
        const response = await fetch("/backupDb");
        const res = await response.json();
        console.log(res);
      }


      async function saveSettings(){
        event.preventDefault();
        if (saveOutcomeAlert.hidden == false){
          saveOutcomeAlert.hidden = true;
        }
        let error = false
        formstuff = new FormData();

        //backups are turned on 
        if (backupToggle.checked){

          if (backupInput.value == ""){
            //set alert to notify that you need to set a directory if backups are on.
            if (!backupAlert.classList.contains("alert-danger")){
              backupAlert.classList.add("alert-danger")
            }
            backupAlert.innerText = "You need to designate a directory to save your backups to."
            error = true;
          }
          else if (backupInput.value.slice(-1) != "/"){
            
            backupAlert.innerText = "Your backup location must end in a / (because it's a directory!)"
            error = true;
          }
          else
          {
            
            formstuff.append("backupDirectory", backupInput.value);
            formstuff.append("backupFreq",backupFreq.value);
            formstuff.append("backupStatus", "on");

          }
        }
        else
        {
          formstuff.append("backupStatus", "off");
        }
        //------------backup details dealt with--------------

        if (error == false){
          const updateSettings = await fetch("/update_settings", {method:'POST', body:formstuff});
          const updateRes = await updateSettings.json();
          console.log(updateRes)
          let outcome = ""

          if (updateRes.ok == "true"){
            
            console.log("settings has been updated");
            outcome = "Settings saved successfully!";
            nextBackupText.innerText =  "Next backup is due on "+updateRes.next_backup
            saveOutcomeAlert.classList.add("alert-success")
          }
          else if (updateRes.ok == "false"){
            console.log("did not update because of an error");
            outcome = updateRes.ok;
          }
          saveOutcomeAlert.innerText = outcome;
          saveOutcomeAlert.hidden = false;
        }
      
      }



    </script>
  </body>
</html>