<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PlatePlanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  </head>
  <body>
    <section>
         <header >
          <nav class="navbar navbar-expand-lg bg-body-tertiary mb-5">
            <div class="container-fluid">
              <a class="navbar-brand" href="#"><strong>PlatePlanner</strong></a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                  <li class="nav-item">
                    <a class="nav-link "  href="/">Home</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link " href="/recipes">Recipes</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="/add_recipe">Manual Add</a>
                  </li>
                  <li class="nav-item" >
                    <a class="nav-link"  href="/ai_recipe_add">AI Add</a>
                  </li>
                  <li class="nav-item" >
                    <a class="nav-link" href="/shopping_list">Shopping List</a>
                  </li>
                  <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                      Dev Tools
                    </a>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="/database_build">Rebuild DB</a></li>
                      <li><a class="dropdown-item" href="#">Another action</a></li>
                      <li><a class="dropdown-item" href="#">Something else here</a></li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
          </nav>
        </header>
    </section>
    <section>
        
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="/view_recipe?q={{recipe_details['id']}}">{{recipe_details['name']}}</a></li>
                                <li class="breadcrumb-item active" aria-current="page"> Edit</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
            <div class="row justify-content-md-center ">

                <div class="col col-12 col-md-6 ">
                    <div class="card mt-2">
                        <div class="accordion" id="accordionExample">
                            <!-- FIRST ITEM -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                <button class="accordion-button " type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#collapseOne" 
                                        aria-expanded="true" aria-controls="collapseOne">
                                    Required details
                                </button>
                                </h2>
                                <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    <strong>These are the details required to save your recipe</strong> <br>
                                    <small>These fields are required to save the recipe!</small>
                                    <form id="recipe_details">
                                    <div class="mb-3 mt-3 mx-auto text-center" >
                                        <label class="form-label" for="recipe_name">Recipe Name</label>
                                        <input type="text" class="form-control w-100" name="recipe_name" id="recipe_name" value="{{recipe_details['name']}}">
                                    </div>
                                    
                                    <div class="mb-3 mt-3 mx-auto text-center" >
                                        <label class="form-label" for="recipe_location">Recipe Location</label>
                                        <input type="text" class="form-control w-100" name="where" id="recipe_location" value="{{recipe_details['location']}}">
                                    <div id="location-help" class="form-text">Name of the recipe book or website. </div>

                                    </div>
                                    <div class="mb-3 mx-auto text-center">
                                        <label class="form-label" for="ingredients">Ingredients</label>
                                        <textarea class=" form-control w-100" style="height:10em;" name="ingredients" id="ingredients" aria-describedby="ingredients-help">{{recipe_ingredients}}
                                            </textarea>
                                        <div id="ingredients-help" class="form-text">Ingredients in a comma seperated list.</div>
                                    </div>
                                    <div class="mb-3 mx-auto text-center" >
                                        <label class="form-label" for="recipe_photo">Photo</label>
                                        <input type="file" class="form-control w-100" name="recipe_photo" id="recipe_photo">
                                    </div>
                                    </form> <!-- FORM 1 CLOSED -->
                                </div> <!-- ACCORDION-BODY 1 CLOSED -->
                                </div> <!-- COLLAPSE 1 CLOSED -->
                            </div> <!-- ITEM 1 CLOSED -->

                            <!-- SECOND ITEM -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#collapseTwo" 
                                        aria-expanded="false" aria-controls="collapseTwo">
                                    Additional Details
                                </button>
                                </h2>
                                <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    <strong>Add additional details that aren't required but are helpful! </strong> 
                                    <form id="additional_details"> <!-- UNIQUE FORM ID -->
                                    <div class="mb-3 mx-auto text-center">
                                        <label class="form-label" for="instructions">Instructions</label>
                                        <textarea class="form-control w-100" style="height:10em; width:20em" 
                                                name="instructions" id="instructions" aria-describedby="instructions-help">{{recipe_details['instructions']}}</textarea>
                                        <div id="instructions-help" class="form-text">instructions from the recipe</div>
                                    </div>
                                    <div class="mb-3 mx-auto text-center">
                                        <label class="form-label" for="description">Description (100 chars)</label>
                                        <textarea class="form-control w-100" style="height:10em; width:20em" 
                                                name="description" id="description" aria-describedby="description-help">{{recipe_details['desc']}}</textarea>
                                        <div id="description-help" class="form-text">Description of the recipe</div>
                                    </div>
                                    <div class="mb-3 mx-auto text-center" >
                                        <label class="form-label" for="page_number">Page Number?</label>
                                        <input type="text" class="form-control w-100" name="page_number" id="page_number" value="{{recipe_details['page_nu']}}">
                                    </div>
                                    <div class="mb-3 mx-auto text-center" >
                                        <label for="difficulty_range" class="form-label">Difficulty</label>
                                        {% set difficultyValue = 0 %}
                                        {% if recipe_details['difficulty'] == 'Easy' %}
                                            {% set difficultyValue = 0 %}
                                        {% elif recipe_details['difficulty'] == 'Medium' %}
                                            {% set difficultyValue = 1 %}
                                        {% else %}
                                            {% set difficultyValue = 2 %}
                                        {% endif %}
                                        <input type="range" class="form-range w-100" step="1" min="0" max="2" value="{{difficultyValue}}" id="difficulty_range">
                                        <output for="difficulty_range" id="rangeValue"> {{recipe_details['difficulty']}}</output>
                                    </div>
                                    <div class="mb-3 mx-auto text-center" >
                                        <label class="form-label" for="category_selector">Category</label>
                                        <select class="form-control" id="category_selector" >
                                            <option>Dinner</option>
                                            <option>Dessert</option>
                                            <option>Other</option>
                                        </select>
                                        
                                    </div>
                                    <div class="mb-3 mx-auto text-center" >
                                        <label class="form-label" for="tags">Tags</label>
                                        <input type="text" class="form-control w-100" name="tags" id="tags" aria-describedby="tags-help" value="{{recipe_details['tags']}}">
                                        <div id="tags-help" class="form-text"># seperated list of tags relating to this recipe.</div>

                                    </div>

                                    </form> <!-- FORM 2 CLOSED -->
                                </div> <!-- ACCORDION-BODY 2 CLOSED -->
                                </div> <!-- COLLAPSE 2 CLOSED -->
                            </div> <!-- ITEM 2 CLOSED -->
                            </div> <!-- ACCORDION CLOSED -->

                        
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col col-12">
                    <div class=" text-center mt-3">
                        <div class="spinner-border text-info" id="spinner" role="status">
                                <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="alert invisible" role="alert" id="alert_field"></div>
                        <p><button id="save_button" class="btn btn-primary mt-5" onclick='save_edited_recipe()'>Save Recipe</button></p>
                    </div>
                </div>
            </div>
        </div>
        
    </section>
   
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script>
        
        const alert_field = document.getElementById("alert_field");
                
        const page_number = document.getElementById("page_number");
        const instructions = document.getElementById("instructions");
        const ingredients = document.getElementById("ingredients")
        ingredients.addEventListener("change", function(){ingredients_field = ingredients.value;checkRequired();setFieldColour(ingredients)})
        const name_field = document.getElementById("recipe_name")
        name_field.addEventListener("change", function(){recipe_name_field = name_field.value;checkRequired(),setFieldColour(name_field)})
        const recipe_location = document.getElementById("recipe_location")
        recipe_location.addEventListener("change", function(){location_field = recipe_location.value;checkRequired(),setFieldColour(recipe_location)})
        const description = document.getElementById("description")
        const recipe_photo = document.getElementById("recipe_photo");
        const rangeInput = document.getElementById('difficulty_range');
        const rangeOutput = document.getElementById('rangeValue');

        const spinner_div = document.getElementById('spinner');
        const save_button = document.getElementById('save_button')
        const catergorySelector = document.getElementById('category_selector')
        const tags = document.getElementById("tags")
        const recipe_id = "{{ recipe_details['id'] }}";
        
        catergorySelector.value = capitalizeFirstLetter("{{recipe_details['category']}}")
        save_button.disabled = true;
        spinner_div.hidden = true;
        checkRequired()

        let difficulty_text = "Easy"
        rangeInput.addEventListener('input', function() {
            if (this.value == 0){
                difficulty_text = "Easy"
            }
            if (this.value == 1){
                difficulty_text = "Medium"
            }
            if (this.value == 2){
                difficulty_text = "Hard"
            }
            rangeOutput.textContent = difficulty_text;
        });

        function setFieldColour(field){
            if(field.value != ""){
                field.classList.add("bg-success-subtle")
            } else if (field.value == ""){
                if (field.classList.contains("bg-success-subtle")){
                    field.classList.remove("bg-success-subtle")
                }
            }
        }
        function checkRequired(){
            if (recipe_name.value != "" & recipe_location.value != "" & ingredients.value != ""){
                save_button.disabled = false;
                setFieldColour(recipe_name);
                setFieldColour(recipe_location);
                setFieldColour(ingredients);
            }
            else{
                save_button.disabled = true;
                console.log()
            }
        }
        

        async function save_edited_recipe(){
            toggleErrorAlert("off")
            const formData = new FormData();
            
            formData.append("saveType", "edit");
            formData.append("recipe_id", recipe_id)
            formData.append("recipe_name", name_field.value);
            formData.append("recipe_location", recipe_location.value);
            formData.append("page_number", page_number.value);
            formData.append("instructions", instructions.value);
            formData.append("description", description.value)
            formData.append("ingredients", ingredients.value);
            formData.append("difficulty", difficulty_text);
            if (recipe_photo.files.length > 0){
                formData.append("recipe_photo", recipe_photo.files[0]);
            }
            categoryName = catergorySelector.value.toLowerCase()
            formData.append("category",categoryName)
            formData.append("tags",tags.value);

            
            console.log(formData['recipe_name'])
            const response = await fetch("/save_ai_recipe", {
                method: 'POST',
                body: formData
            })
            
            const insert_response = await response.json();
            if (insert_response.ok){
               
                console.log("recipe updated successfully")
                window.location.href = "/view_recipe?q="+insert_response.recipe_Id;

            }
            else {
                alert_field.innerHTML = insert_response.error
                toggleErrorAlert("on")
            } 
        }

        function toggleErrorAlert(state){
                if (state == "on"){
                    if (alert_field.classList.contains("alert-success")){
                        alert_field.classList.remove("alert-success") 
                    }
                alert_field.classList.add("alert-danger")
                alert_field.classList.remove("invisible")
                alert_field.classList.add("visible")
            }
            else {
                alert_field.classList.remove("visible")
                alert_field.classList.add("invisible")
            }
        }
        function toggleSuccessAlert(state){
                if (state == "on"){
                    if (alert_field.classList.contains("alert-danger")){
                        alert_field.classList.remove("alert-danger")
                    }
                alert_field.classList.add("alert-success")
                alert_field.classList.remove("invisible")
                alert_field.classList.add("visible")
            }
            else {
                alert_field.classList.remove("visible")
                alert_field.classList.add("invisible")
            }
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
    </script>

    </body>
</html>